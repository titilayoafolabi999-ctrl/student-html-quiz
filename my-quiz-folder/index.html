<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HTML Mastery Quiz — Student</title>

  <!-- Tailwind CDN (for quick prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Simple color theme: teal (was indigo) -->
  <style>
    :root {
      --brand: #0f766e; /* teal-700 */
      --brand-500: #14b8a6; /* teal-400 */
      --muted: #64748b;
    }
    .brand-bg { background-color: var(--brand); }
    .brand-500 { color: var(--brand-500); }
    .brand-border { border-color: rgba(15,118,110,0.08); }
    .teacher-login-btn { background: var(--brand); }
  </style>

  <!-- Icons (Font Awesome) -->
  <script src="https://kit.fontawesome.com/yourkitid.js" crossorigin="anonymous"></script>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">

  <main class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-4xl">

      <!-- LOGIN VIEW -->
      <section id="login-view" class="bg-white p-10 rounded-3xl shadow-xl text-center max-w-md mx-auto border brand-border">
        <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-6 text-teal-600">
          <i class="fa-solid fa-user-graduate text-3xl"></i>
        </div>
        <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Student Login</h1>
        <p class="text-slate-500 mb-6">Enter your name to sign in or create an account.</p>

        <input id="student-name-input" type="text" placeholder="Full Name (e.g. John Doe)"
               class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-teal-300 outline-none transition-all font-bold text-center" />

        <div class="flex gap-3 justify-center">
          <button onclick="handleLogin()" class="px-6 py-3 rounded-xl bg-emerald-600 text-white font-bold shadow hover:brightness-95">Login</button>
          <button onclick="handleCreateAccount()" class="px-6 py-3 rounded-xl bg-white border border-slate-200 text-slate-700 font-bold hover:bg-slate-50">Create Account</button>
        </div>
      </section>

      <!-- MAIN MENU -->
      <section id="menu-view" class="hidden mt-8">
        <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
          <div class="flex items-center justify-between mb-6">
            <div>
              <div class="text-sm text-slate-500 uppercase font-bold">Welcome</div>
              <div class="text-2xl font-black" id="display-name">Student</div>
            </div>
            <div class="flex gap-3 items-center">
              <div class="text-right">
                <div class="text-xs text-slate-400 uppercase">Total Points</div>
                <div class="text-2xl font-black" id="stat-score">0</div>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-400 uppercase">Modules Done</div>
                <div class="text-2xl font-black" id="stat-completed">0/3</div>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-400 uppercase">Connection</div>
                <div class="text-2xl font-black brand-500" id="stat-sync">Live</div>
              </div>
              <button id="logout-btn" onclick="logout()" class="ml-4 px-4 py-2 rounded-lg bg-white border border-slate-200">Logout</button>
            </div>
          </div>

          <!-- Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-6 bg-white rounded-2xl border border-slate-100">
              <h3 class="text-xl font-bold text-slate-700">Beginner</h3>
              <p class="text-sm text-slate-400 mt-2 mb-4">Foundations</p>
              <div id="card-beginner" class="text-slate-500 font-bold">Locked</div>
              <button onclick="startLevel('beginner')" class="mt-4 w-full py-3 rounded-xl bg-teal-600 text-white font-bold">Start</button>
            </div>

            <div class="p-6 bg-white rounded-2xl border border-slate-100">
              <h3 class="text-xl font-bold text-slate-700">Intermediate</h3>
              <p class="text-sm text-slate-400 mt-2 mb-4">Layout & Tags</p>
              <div id="card-intermediate" class="text-slate-500 font-bold">Locked</div>
              <button onclick="startLevel('intermediate')" class="mt-4 w-full py-3 rounded-xl bg-white border border-slate-200 font-bold">Start</button>
            </div>

            <div class="p-6 bg-white rounded-2xl border border-slate-100">
              <h3 class="text-xl font-bold text-slate-700">Advanced</h3>
              <p class="text-sm text-slate-400 mt-2 mb-4">Semantic & Best Practices</p>
              <div id="card-advanced" class="text-slate-500 font-bold">Locked</div>
              <button onclick="startLevel('advanced')" class="mt-4 w-full py-3 rounded-xl bg-white border border-slate-200 font-bold">Start</button>
            </div>
          </div>
        </div>
      </section>

      <!-- QUIZ VIEW -->
      <section id="quiz-view" class="hidden mt-6">
        <div class="bg-white rounded-3xl p-8 shadow border border-slate-100">
          <div class="mb-6">
            <div id="q-counter" class="text-xs font-black uppercase text-teal-500"></div>
            <h2 id="q-text" class="text-2xl font-bold leading-tight mb-4"></h2>
            <div id="options-grid" class="grid grid-cols-1 gap-3"></div>
          </div>
        </div>
      </section>

      <!-- RESULT VIEW -->
      <section id="result-view" class="hidden mt-6 text-center">
        <div class="max-w-md mx-auto bg-white rounded-3xl shadow-2xl p-8 border border-slate-100">
          <div id="result-icon-container" class="w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 bg-green-100 text-green-600">
            <i id="result-icon" class="fa-solid fa-check-circle text-3xl"></i>
          </div>
          <h2 id="result-title" class="text-2xl font-black mb-2"></h2>
          <p id="result-message" class="text-slate-600 mb-4"></p>
          <p id="result-score-text" class="text-slate-500 mb-4"></p>

          <div class="space-y-3">
            <button onclick="exitToMenu()" class="w-full py-3 bg-slate-900 text-white rounded-2xl font-bold">Return to Dashboard</button>
            <button id="retry-btn" onclick="retryLevel()" class="w-full py-3 bg-white border-2 border-slate-200 rounded-2xl font-bold">Retry Attempt</button>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Inline scripts: Quiz logic, per-student storage, submit hook, and small teacher portal (polling) -->
  <script>
    // --- Config & State ---
    const PASS_MARK = 16; // adjust to your question count
    let studentName = localStorage.getItem('student_name') || "";
    let progress = { beginner: false, intermediate: false, advanced: false };
    let scores = { beginner: 0, intermediate: 0, advanced: 0 };
    let currentLevelKey = null;
    let currentIndex = 0;
    let currentScore = 0;

    // Storage helpers (per-student)
    function progressKey(name) { return `html_progress_${name}`; }
    function scoresKey(name) { return `html_scores_${name}`; }

    function loadStudentState() {
      if (!studentName) return;
      progress = JSON.parse(localStorage.getItem(progressKey(studentName))) || { beginner:false, intermediate:false, advanced:false };
      scores = JSON.parse(localStorage.getItem(scoresKey(studentName))) || { beginner:0, intermediate:0, advanced:0 };
      document.getElementById('display-name').innerText = studentName;
      updateMenuUI();
    }

    function saveStudentState() {
      if (!studentName) return;
      localStorage.setItem(progressKey(studentName), JSON.stringify(progress));
      localStorage.setItem(scoresKey(studentName), JSON.stringify(scores));
    }

    // --- Login / Create / Logout ---
    async function handleLogin() {
      const name = document.getElementById('student-name-input').value.trim();
      if (name.length < 3) return alert("Please enter your full name.");
      // If not found, prompt to create
      if (!localStorage.getItem(progressKey(name)) && !localStorage.getItem(scoresKey(name))) {
        if (!confirm("No account found. Create a new account?")) return;
        // initialize
        localStorage.setItem(progressKey(name), JSON.stringify({ beginner:false, intermediate:false, advanced:false }));
        localStorage.setItem(scoresKey(name), JSON.stringify({ beginner:0, intermediate:0, advanced:0 }));
      }
      studentName = name;
      localStorage.setItem('student_name', studentName);
      loadStudentState();
      checkAuth();
    }

    function handleCreateAccount() {
      const name = document.getElementById('student-name-input').value.trim();
      if (name.length < 3) return alert("Please enter your full name.");
      studentName = name;
      if (!localStorage.getItem(progressKey(studentName))) {
        localStorage.setItem(progressKey(studentName), JSON.stringify({ beginner:false, intermediate:false, advanced:false }));
      }
      if (!localStorage.getItem(scoresKey(studentName))) {
        localStorage.setItem(scoresKey(studentName), JSON.stringify({ beginner:0, intermediate:0, advanced:0 }));
      }
      localStorage.setItem('student_name', studentName);
      loadStudentState();
      checkAuth();
    }

    function logout() {
      // Only remove session; keep per-student stored data
      localStorage.removeItem('student_name');
      studentName = "";
      // reset in-memory
      progress = { beginner:false, intermediate:false, advanced:false };
      scores = { beginner:0, intermediate:0, advanced:0 };
      location.reload();
    }

    // --- Menu UI and Level control ---
    function updateMenuUI() {
      document.getElementById('stat-score').innerText = Object.values(scores).reduce((a,b)=>a+b,0);
      document.getElementById('stat-completed').innerText = `${Object.values(progress).filter(v=>v).length}/3`;
      // Cards
      document.getElementById('card-beginner').innerText = progress.beginner ? 'Completed' : 'Unlocked';
      document.getElementById('card-intermediate').innerText = progress.intermediate ? 'Completed' : 'Locked';
      document.getElementById('card-advanced').innerText = progress.advanced ? 'Completed' : 'Locked';
    }

    function checkAuth() {
      // If signed in, show menu; otherwise show login
      if (studentName) {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('menu-view').classList.remove('hidden');
      } else {
        document.getElementById('login-view').classList.remove('hidden');
        document.getElementById('menu-view').classList.add('hidden');
      }
    }

    function startLevel(level) {
      // enforce lock: intermediate locked until beginner completed, etc.
      if (level === 'intermediate' && !progress.beginner) return alert('Complete Beginner first.');
      if (level === 'advanced' && !progress.intermediate) return alert('Complete Intermediate first.');
      currentLevelKey = level;
      currentIndex = 0;
      currentScore = 0;
      renderQuestion();
      document.getElementById('menu-view').classList.add('hidden');
      document.getElementById('quiz-view').classList.remove('hidden');
    }

    function exitToMenu() {
      document.getElementById('quiz-view').classList.add('hidden');
      document.getElementById('result-view').classList.add('hidden');
      document.getElementById('menu-view').classList.remove('hidden');
      updateMenuUI();
    }

    function retryLevel() {
      currentIndex = 0;
      currentScore = 0;
      renderQuestion();
      document.getElementById('result-view').classList.add('hidden');
      document.getElementById('quiz-view').classList.remove('hidden');
    }

    // --- Sample Questions (trimmed) ---
    const QUESTIONS_DATA = {
      beginner: [
        { q: "What does HTML stand for?", o: ["Hyper Text Markup Language","High Text Machine Language","Hyper Tool Markup Language","Home Text Markup Language"], a: 0 },
        { q: "Which file extension is correct for HTML?", o: [".doc",".txt",".html",".exe"], a: 2 },
        { q: "What reads HTML and displays it?", o: ["Server","Compiler","Browser","Editor"], a: 2 }
      ],
      intermediate: [
        { q: "Which tag contains the page title?", o: ["<meta>","<title>","<head>","<body>"], a: 1 },
        { q: "Which element is for navigation?", o: ["<nav>","<main>","<section>","<article>"], a: 0 }
      ],
      advanced: [
        { q: "Which tag improves semantics for articles?", o: ["<div>","<span>","<article>","<figure>"], a: 2 }
      ]
    };

    // --- Rendering & Answer handling ---
    function renderQuestion() {
      const qData = QUESTIONS_DATA[currentLevelKey][currentIndex];
      document.getElementById('q-counter').innerText = `Challenge ${currentIndex+1} of ${QUESTIONS_DATA[currentLevelKey].length}`;
      document.getElementById('q-text').innerText = qData.q;
      const grid = document.getElementById('options-grid');
      grid.innerHTML = '';
      qData.o.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "option-hover w-full text-left p-4 rounded-xl border border-slate-100 hover:border-teal-500 hover:bg-teal-50 transition-all flex items-center";
        btn.onclick = () => handleAnswer(idx);
        btn.innerHTML = `<div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center font-black mr-4">${String.fromCharCode(65+idx)}</div><div class="text-slate-700 font-bold">${opt}</div>`;
        grid.appendChild(btn);
      });
    }

    function handleAnswer(idx) {
      if (idx === QUESTIONS_DATA[currentLevelKey][currentIndex].a) currentScore++;
      if (currentIndex < QUESTIONS_DATA[currentLevelKey].length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        finishLevel();
      }
    }

    // --- Sync helpers ---
    function showSyncStatus(ok) {
      const el = document.getElementById('stat-sync');
      el.innerText = ok ? 'Live' : 'Offline';
      el.className = ok ? 'brand-500' : '';
    }

    // --- finishLevel: update local storage per student and send to Netlify function ---
    async function finishLevel() {
      const total = QUESTIONS_DATA[currentLevelKey].length;
      const passed = currentScore >= PASS_MARK || currentScore === total; // for demo
      document.getElementById('quiz-view').classList.add('hidden');
      document.getElementById('result-view').classList.remove('hidden');
      document.getElementById('result-score-text').innerText = `Final Score: ${currentScore} / ${total}`;

      if (passed) {
        progress[currentLevelKey] = true;
        scores[currentLevelKey] = currentScore;

        // Save per-student or fallback
        if (studentName) {
          localStorage.setItem(progressKey(studentName), JSON.stringify(progress));
          localStorage.setItem(scoresKey(studentName), JSON.stringify(scores));
        } else {
          localStorage.setItem('html_progress_v2', JSON.stringify(progress));
          localStorage.setItem('html_scores', JSON.stringify(scores));
        }

        document.getElementById('result-title').innerText = "Level Unlocked!";
        document.getElementById('result-message').innerText = "Excellent! Data has been synced to your permanent record.";
        document.getElementById('retry-btn').classList.add('hidden');

        showSyncStatus(true);
        try {
          await fetch('/.netlify/functions/submit-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              studentName,
              level: currentLevelKey,
              score: currentScore,
              total,
              timestamp: new Date().toISOString()
            })
          });
        } catch (e) {
          console.warn('Submit failed', e);
          showSyncStatus(false);
        }
      } else {
        document.getElementById('result-title').innerText = "Try Again";
        document.getElementById('result-message').innerText = "You didn't meet the pass threshold. Give it another try!";
      }
      updateMenuUI();
    }

    // --- Init on load ---
    (function init() {
      checkAuth();
      if (studentName) loadStudentState();
      updateMenuUI();
    })();

    // --- Small teacher portal (polling) - injected UI, protected by validate-reset action ---
    (function teacherPortal() {
      const POLL_INTERVAL = 3000;
      // Create teacher login button
      const teacherBtn = document.createElement('button');
      teacherBtn.className = 'teacher-login-btn fixed bottom-6 right-6 z-50 p-3 text-white rounded-lg shadow-lg';
      teacherBtn.textContent = 'Teacher Login';
      teacherBtn.onclick = openTeacherPortal;
      document.body.appendChild(teacherBtn);

      // Portal container
      const portal = document.createElement('div');
      portal.id = 'teacher-portal';
      portal.style = 'display:none;position:fixed;right:18px;bottom:90px;width:360px;max-height:60vh;overflow:auto;background:#fff;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.12);padding:12px;z-index:9999';
      portal.innerHTML = '<h3 class="font-bold mb-2">Live Submissions</h3><ul id="live-feed" class="text-sm" style="list-style:none;padding:0;margin:0"></ul><div class="text-right mt-3"><button id="close-portal" class="px-3 py-1 rounded bg-slate-100">Close</button></div>';
      document.body.appendChild(portal);
      document.getElementById('close-portal').onclick = closePortal;

      let pollId = null;
      let lastTs = 0;

      async function openTeacherPortal() {
        const code = prompt('Enter teacher code:');
        if (!code) return;
        try {
          const res = await fetch('/.netlify/functions/submit-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'validate-reset', code })
          });
          const data = await res.json();
          if (!data.success) {
            alert('Invalid code');
            return;
          }
          portal.style.display = 'block';
          fetchLatest();
          pollId = setInterval(fetchLatest, POLL_INTERVAL);
        } catch (err) {
          console.error(err);
          alert('Auth check failed.');
        }
      }

      function closePortal() {
        portal.style.display = 'none';
        if (pollId) clearInterval(pollId);
        pollId = null;
      }

      async function fetchLatest() {
        try {
          const r = await fetch('/.netlify/functions/get-scores');
          if (!r.ok) throw new Error('Fetch failed');
          const items = await r.json();
          if (!Array.isArray(items)) return;
          // Filter new items by timestamp
          const newItems = items.filter(i => {
            const t = i.timestamp ? new Date(i.timestamp).getTime() : 0;
            return t > lastTs;
          });
          if (items.length) {
            const tsList = items.map(i => i.timestamp ? new Date(i.timestamp).getTime() : 0);
            lastTs = Math.max(lastTs, ...tsList);
          }
          if (newItems.length) appendToFeed(newItems);
        } catch (err) {
          console.error('Polling error', err);
        }
      }

      function appendToFeed(items) {
        const list = document.getElementById('live-feed');
        items.forEach(it => {
          const li = document.createElement('li');
          li.className = 'p-2 border-b border-slate-100';
          const name = it.studentName || it.Name || 'Unknown';
          const level = it.level || it.Level || '';
          const score = it.score || it.Score || '';
          const ts = it.timestamp || new Date().toISOString();
          li.innerHTML = `<div class="font-semibold">${escapeHtml(name)} — ${escapeHtml(level)} <span class="text-slate-400 font-normal">(${escapeHtml(score)})</span></div>
                          <div class="text-slate-400 text-xs">${new Date(ts).toLocaleString()}</div>`;
          list.insertBefore(li, list.firstChild);
        });
        while (list.children.length > 200) list.removeChild(list.lastChild);
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
      }

      // Expose for debugging
      window.__teacherPortal = { open: openTeacherPortal, close: closePortal, fetchLatest };
    })();
  </script>

</body>
</html>
